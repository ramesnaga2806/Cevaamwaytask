<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Manager (CEVA & Amway)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f6fb;
      font-size: 18px;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      width: 90%;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      border: 3px solid #007bff;
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
    }
    h1 { text-align:center; color:#333; border-bottom:4px solid #007bff; padding-bottom:12px; font-size:2.5rem; margin-bottom:20px; }
    h2 { font-size:1.8rem; color:#007bff; margin-top:25px; }
    h3 { font-size:1.5rem; color:#333; margin:20px 0 10px; }

    .nav { display:flex; gap:15px; margin-bottom:25px; justify-content:center; flex-wrap:wrap; }
    .nav button { padding:14px 28px; background:#007bff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1.2rem; min-width:160px; transition:all .3s; }
    .nav button:hover { background:#0056b3; transform:translateY(-2px); }

    .page { display:none; }
    .page.active { display:block; }

    .form-group { margin-bottom:20px; }
    .form-group label { display:block; margin-bottom:8px; font-weight:bold; color:#333; font-size:1.2rem; }
    .form-group input,
    .form-group select,
    .form-group textarea { width:100%; padding:12px; border:2px solid #aaa; border-radius:8px; font-size:1.1rem; box-sizing:border-box; transition:border .3s; }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus { border-color:#007bff; outline:none; }

    button { padding:12px 20px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:1.1rem; font-weight:bold; transition:all .3s; }
    button:hover { background:#218838; transform:translateY(-2px); }
    button:disabled { background:#ccc; cursor:not-allowed; transform:none; }

    table { 
      width:100%; 
      border-collapse:collapse; 
      margin-top:20px; 
      border:3px solid #007bff; 
      font-size:1.1rem; 
      table-layout:auto; /* Critical for resize */
    }
    th, td { 
      border:2px solid #bbb; 
      padding:14px; 
      text-align:left; 
      vertical-align:top; 
      word-wrap:break-word; 
    }
    th { background:#007bff; color:#fff; font-size:1.2rem; font-weight:bold; }
    tr.status-open      { background:#fff9c4; }
    tr.status-inprogress{ background:#ffe0b2; }
    tr.status-complete  { background:#c8e6c9; }

    td input[type="text"] { 
      width:100%; padding:6px 8px; font-size:.95rem; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; 
    }

    /* UPDATE REMARK – FULLY RESIZABLE ON ALL SIDES */
    td.update-remark {
      min-width: 350px;
      width: 100%;
      flex: 3;
      white-space: pre-wrap;
      word-wrap: break-word;
      position: relative;
    }
    td.update-remark textarea {
      width: 100% !important;
      min-height: 200px;
      max-height: 500px;
      min-width: 300px;
      resize: both; /* RESIZE ALL SIDES */
      overflow: auto;
      font-family: inherit;
      font-size: 1.1rem;
      padding: 12px;
      box-sizing: border-box;
      border: 2px solid #007bff;
      border-radius: 6px;
      background: #f9f9ff;
      touch-action: manipulation; /* Mobile resize support */
      -webkit-appearance: none;
    }

    /* Show resize grip */
    td.update-remark textarea::-webkit-resizer {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23007bff" d="M12 10v2H0v-2h12zM12 5v2H0V5h12zM12 0v2H0V0h12z"/></svg>') no-repeat center;
      background-size: 10px;
    }

    .note { background:#f1f1f1; padding:20px; border-left:6px solid #007bff; margin-top:30px; border-radius:8px; font-size:1.1rem; }
    .note ul { margin:10px 0; padding-left:20px; }
    .note li { margin-bottom:8px; }

    .loading-message { text-align:center; color:#007bff; font-weight:bold; margin-bottom:20px; font-size:1.3rem; display:block; }
    .loading-message.hidden { display:none; }

    /* MOBILE */
    @media screen and (max-width:768px) {
      body { font-size:16px; }
      .container { padding:20px; width:95%; margin:15px auto; }
      h1 { font-size:2rem; }
      .nav { flex-direction:column; align-items:center; gap:12px; }
      .nav button { width:100%; padding:16px; font-size:1.1rem; }
      table { display:block; overflow-x:auto; white-space:nowrap; font-size:1rem; }
      th, td { font-size:.95rem; padding:10px; min-width:80px; }
      td input[type="text"] { padding:5px 6px; font-size:.9rem; }

      td.update-remark {
        min-width: 250px;
        flex: 3;
        display: block;
        width: 100%;
      }
      td.update-remark textarea {
        min-height: 160px;
        min-width: 220px;
        font-size: 1rem;
        padding: 10px;
        resize: both; /* Works on mobile with touch */
      }
    }

    @media screen and (min-width:769px) {
      .nav { flex-direction:row; }
      table { overflow-x:visible; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Task Manager (CEVA & Amway)</h1>

    <!-- Navigation -->
    <div class="nav">
      <button onclick="showPage('login')">Login</button>
      <button onclick="showPage('task-assignment')">Task Assignment</button>
      <button onclick="showPage('view-report')">View Report</button>
      <button onclick="managerLogin()">Manager Control</button>
      <button onclick="logout()">Logout</button>
    </div>

    <!-- Login Page -->
    <div id="login" class="page active">
      <h2>Login</h2>
      <div id="loading-message" class="loading-message">Loading application, please wait...</div>
      <div class="form-group"><label>User Name</label><input type="text" id="username" placeholder="Enter username"/></div>
      <div class="form-group"><label>Password</label><input type="password" id="password" placeholder="Enter password"/></div>
      <button id="login-button" onclick="login()" disabled>Login</button>
    </div>

    <!-- Task Assignment Page -->
    <div id="task-assignment" class="page">
      <h2>Task Assignment</h2>
      <div class="form-group"><label>Title (required)</label><input type="text" id="task-title"/></div>
      <div class="form-group"><label>Email Subject (optional)</label><input type="text" id="email-subject"/></div>
      <div class="form-group"><label>Request By</label><input type="text" id="request-by" readonly/></div>
      <div class="form-group"><label>Remark</label><textarea id="remark"></textarea></div>
      <div class="form-group"><label>Department</label>
        <select id="department"><option value="">Select Department</option></select>
      </div>
      <button onclick="addTask()">Add Task</button>
    </div>

    <!-- View Report Page -->
    <div id="view-report" class="page">
      <h2>View Report</h2>
      <div class="form-group"><label>Filter by Department</label>
        <select id="filter-department" onchange="loadTasks()"><option value="">All Departments</option></select>
      </div>
      <div class="form-group"><label>Filter by Request By</label>
        <select id="filter-request-by" onchange="loadTasks()"><option value="">All Users</option></select>
      </div>

      <table>
        <thead>
          <tr>
            <th>Department</th><th>Title</th><th>Email Subject</th><th>Request By</th><th>Remark</th>
            <th>Created Date</th><th>Incharge Person</th><th>Assign To</th><th>Status</th>
            <th>Update Remark</th><th>Last Submitted At</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="task-list"></tbody>
      </table>
    </div>

    <!-- Manager Control Page -->
    <div id="manager-control" class="page">
      <h2>Manager Control</h2>
      <h3>Create User</h3>
      <div class="form-group"><label>Username</label><input type="text" id="new-username"/></div>
      <div class="form-group"><label>Password</label><input type="password" id="new-password"/></div>
      <div class="form-group"><label>Department</label><select id="user-department"></select></div>
      <div class="form-group"><label>Contract</label>
        <select id="contract"><option value="CEVA">CEVA</option><option value="AMWAY">AMWAY</option></select>
      </div>
      <button onclick="createUser()">Create User</button>

      <h3>Add Department</h3>
      <div class="form-group"><label>Department Name</label><input type="text" id="new-department"/></div>
      <button onclick="addDepartment()">Add Department</button>

      <h3>Delete Department</h3>
      <div class="form-group"><label>Select Department</label><select id="delete-department"></select></div>
      <button onclick="deleteDepartment()">Delete Department</button>

      <h3>Delete User</h3>
      <div class="form-group"><label>Username</label><input type="text" id="delete-username"/></div>
      <button onclick="deleteUser()">Delete User</button>

      <h3>Change Password</h3>
      <div class="form-group"><label>Username</label><input type="text" id="change-username"/></div>
      <div class="form-group"><label>New Password</label><input type="password" id="change-new-password"/></div>
      <button onclick="changeUserPassword()">Change Password</button>

      <h3>Reset Password</h3>
      <div class="form-group"><label>Username</label><input type="text" id="reset-username"/></div>
      <button onclick="resetPassword()">Reset</button>

      <h3>Download Data</h3>
      <div class="form-group"><label>Date Range</label><input type="text" id="date-range"/></div>
      <div class="form-group"><label>Username</label><input type="text" id="download-username"/></div>
      <button onclick="downloadData()">Download</button>

      <h3>Delete Data by Date Range</h3>
      <div class="form-group"><label>Date Range (YYYY-MM-DD to YYYY-MM-DD)</label>
        <input type="text" id="delete-date-range" placeholder="e.g., 2025-01-01 to 2025-12-31"/>
      </div>
      <button onclick="deleteTasksByDateRange()">Delete Tasks</button>

      <div class="note">
        <h3>Notes</h3>
        <ul>
          <li>Status Colors: Open (yellow), In Progress (orange), Complete (green).</li>
          <li>CEVA users see CEVA + synced Amway tasks. Amway users see Amway tasks only.</li>
          <li>Incharge Person, Assign To, Status, and Update Remark are editable by all users.</li>
          <li>Only the task creator can complete tasks.</li>
          <li>Completed tasks are archived in Firestore for 6 months.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- FIREBASE + LOGIC (unchanged) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc,
      query, where, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCIHSP94B2A3WTEviUCxXqkL_iB1KzmJNw",
      authDomain: "task-manager-35519.firebaseapp.com",
      projectId: "task-manager-35519",
      storageBucket: "task-manager-35519.firebasestorage.app",
      messagingSenderId: "409588015669",
      appId: "1:409588015669:web:dc81e7239c0b64bf66877c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let isInitialized = false, currentUser = null, isCEVA = false, currentContract = "";
    let departments = [], amwayDepartments = ["Amway"], users = [], tasks = [], unsubscribeTasks = null;

    async function initializeData(attempt = 1, maxAttempts = 3) {
      try {
        const deptSnap = await getDocs(collection(db, "departments"));
        departments = deptSnap.docs.map(d => d.data().name);
        if (!departments.length) {
          departments = ["Amway"];
          for (const d of departments) await setDoc(doc(db, "departments", d), { name: d });
        }

        const userSnap = await getDocs(collection(db, "users"));
        users = userSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        if (!users.length) {
          const def = [{ username: "admin", password: "Ceva456", dept: "Amway", contract: "CEVA" }];
          for (const u of def) {
            const ref = doc(db, "users", u.username);
            if (!(await getDoc(ref)).exists()) await setDoc(ref, u);
          }
          users = def.map(u => ({ id: u.username, ...u }));
        }

        const taskSnap = await getDocs(collection(db, "tasks"));
        tasks = taskSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        await cleanOldArchivedTasks();

        populateDepartments(); populateUsers();
        isInitialized = true;
        document.getElementById("login-button").disabled = false;
        document.getElementById("loading-message").classList.add("hidden");
      } catch (e) {
        if (attempt < maxAttempts) { await new Promise(r=>setTimeout(r,1000)); return initializeData(attempt+1); }
        alert("Failed to initialise – check network & refresh.");
      }
    }

    async function cleanOldArchivedTasks() {
      const sixMonthsAgo = new Date(); sixMonthsAgo.setMonth(sixMonthsAgo.getMonth()-6);
      const snap = await getDocs(collection(db, "archived_tasks"));
      const del = snap.docs.filter(d=>{
        const t = d.data(); const c = new Date(t.completedAt);
        return c < sixMonthsAgo;
      }).map(d=>deleteDoc(d.ref));
      await Promise.all(del);
    }

    function populateDepartments() {
      ["department","filter-department","user-department","delete-department"].forEach(id=>{
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = (id==="delete-department")?"":`<option value="">${id==="filter-department"?"All Departments":"Select Department"}</option>`;
        departments.forEach(d=>{
          const o = document.createElement("option"); o.value=o.text=d; sel.appendChild(o);
        });
      });
    }

    function populateUsers() {
      const sel = document.getElementById("filter-request-by");
      sel.innerHTML = '<option value="">All Users</option>';
      users.forEach(u=>{ const o=document.createElement("option"); o.value=o.text=u.username||u.id; sel.appendChild(o); });
    }

    function showPage(id) {
      if ((id==="task-assignment"||id==="view-report"||id==="manager-control") && !currentUser) { alert("Log in first"); return showPage("login"); }
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      const el = document.getElementById(id); if (el) el.classList.add("active");
      if (id==="view-report") loadTasks(); else if (unsubscribeTasks) { unsubscribeTasks(); unsubscribeTasks=null; }
    }

    async function managerLogin() {
      if (!currentUser) return alert("Log in first");
      const p = prompt("Manager Password:");
      if (p==="CevaAmway123") showPage("manager-control"); else alert("Wrong password");
    }

    async function login() {
      if (!isInitialized) return alert("Still loading…");
      const u = document.getElementById("username").value.trim().toLowerCase();
      const p = document.getElementById("password").value.trim();
      if (!u||!p) return alert("Enter both fields");
      const ref = doc(db,"users",u); const snap = await getDoc(ref);
      if (!snap.exists()) return alert("User not found");
      const data = snap.data(); if (data.password!==p) return alert("Wrong password");
      currentUser = data.username||u;
      currentContract = data.contract==="AMWAY"?"AMWAY":"CEVA";
      isCEVA = currentContract==="CEVA";
      document.getElementById("request-by").value = currentUser;
      alert(`Logged in as ${currentUser} (${currentContract})`);
      showPage("task-assignment"); clearTaskAssignmentForm();
    }

    function logout() {
      currentUser=null; isCEVA=false; currentContract="";
      document.getElementById("username").value=document.getElementById("password").value="";
      if (unsubscribeTasks) { unsubscribeTasks(); unsubscribeTasks=null; }
      alert("Logged out"); showPage("login");
    }

    async function addTask() {
      if (!isInitialized) return alert("Still loading…");
      const title = document.getElementById("task-title").value.trim();
      const dept  = document.getElementById("department").value;
      if (!title||!dept) return alert("Title & Department required");
      const id = Date.now().toString();
      const task = {
        id, department:dept, title,
        emailSubject: document.getElementById("email-subject").value.trim(),
        requestBy: currentUser,
        remark: document.getElementById("remark").value.trim(),
        createdDate: new Date().toLocaleString(),
        inchargePerson:"", assignTo:"", status:"Open", updateRemark:"", contract: currentContract,
        isSynced: (isCEVA && amwayDepartments.includes(dept)) || (!isCEVA && currentContract==="AMWAY"),
        lastSubmittedAt:""
      };
      await setDoc(doc(db,"tasks",id),task);
      alert("Task added!"); showPage("view-report");
    }

    async function loadTasks() {
      if (!isInitialized) return alert("Still loading…");
      const tbody = document.getElementById("task-list");
      const deptF = document.getElementById("filter-department").value;
      const userF = document.getElementById("filter-request-by").value;
      if (unsubscribeTasks) { unsubscribeTasks(); unsubscribeTasks=null; }

      unsubscribeTasks = onSnapshot(collection(db,"tasks"), snap=>{
        tasks = snap.docs.map(d=>({id:d.id,...d.data()}));
        tbody.innerHTML="";
        tasks.forEach(t=>{
          if (currentContract==="AMWAY" && t.contract==="CEVA") return;
          if (currentContract==="CEVA" && t.contract==="AMWAY" && !t.isSynced) return;
          if (deptF && t.department!==deptF) return;
          if (userF && t.requestBy!==userF) return;

          const row = document.createElement("tr");
          row.className = `status-${t.status.toLowerCase().replace(" ","")}`;
          row.innerHTML = `
            <td>${escapeHtml(t.department)}</td>
            <td>${escapeHtml(t.title)}</td>
            <td>${escapeHtml(t.emailSubject||"")}</td>
            <td>${escapeHtml(t.requestBy)}</td>
            <td>${escapeHtml(t.remark||"")}</td>
            <td>${escapeHtml(t.createdDate||"")}</td>
            <td><input type="text" value="${escapeAttr(t.inchargePerson||"")}" onchange="updateTask('${t.id}','inchargePerson',this.value)"></td>
            <td><input type="text" value="${escapeAttr(t.assignTo||"")}" onchange="updateTask('${t.id}','assignTo',this.value)"></td>
            <td><select onchange="updateTask('${t.id}','status',this.value)">
                  <option ${t.status==="Open"?"selected":""}>Open</option>
                  <option ${t.status==="In Progress"?"selected":""}>In Progress</option>
                  <option ${t.status==="Complete"?"selected":""}>Complete</option>
                </select></td>
            <td class="update-remark"><textarea onchange="updateTask('${t.id}','updateRemark',this.value)">${escapeAttr(t.updateRemark||"")}</textarea></td>
            <td>${escapeHtml(t.lastSubmittedAt||"")}</td>
            <td><button onclick="submitTask('${t.id}')">Submit</button>
                <button onclick="completeTask('${t.id}')" ${t.requestBy!==currentUser?"disabled":""}>Complete</button></td>`;
          tbody.appendChild(row);
        });
      });
    }

    async function updateTask(id,field,val) {
      await updateDoc(doc(db,"tasks",id),{[field]:val});
    }
    async function submitTask(id) {
      const task = tasks.find(t=>t.id===id);
      const now = new Date().toLocaleString();
      const upd = {inchargePerson:task.inchargePerson,assignTo:task.assignTo,status:task.status,updateRemark:task.updateRemark,lastSubmittedAt:now};
      await updateDoc(doc(db,"tasks",id),upd);
      alert(`Submitted – ${now}`);
    }
    async function completeTask(id) {
      const task = tasks.find(t=>t.id===id);
      if (task.requestBy!==currentUser) return alert("Only creator can complete");
      await setDoc(doc(db,"archived_tasks",id),{...task,completedAt:new Date().toISOString()});
      await deleteDoc(doc(db,"tasks",id));
      alert("Task completed & archived");
    }

    // Manager functions (unchanged) – omitted for brevity
    async function createUser(){/*...*/} async function deleteUser(){/*...*/} async function changeUserPassword(){/*...*/}
    async function addDepartment(){/*...*/} async function deleteDepartment(){/*...*/} async function resetPassword(){/*...*/}
    async function downloadData(){/*...*/} async function deleteTasksByDateRange(){/*...*/}

    function clearTaskAssignmentForm(){
      ["task-title","email-subject","remark","department"].forEach(id=>document.getElementById(id).value="");
    }
    function escapeHtml(s){return s?s.toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])):"";}
    function escapeAttr(s){return escapeHtml(s);}

    initializeData();

    window.showPage=showPage; window.managerLogin=managerLogin; window.login=login; window.logout=logout;
    window.addTask=addTask; window.loadTasks=loadTasks; window.updateTask=updateTask;
    window.submitTask=submitTask; window.completeTask=completeTask;
    // ... expose others
  </script>
</body>
</html>
